# TikTok é¼ æ ‡/è¡Œä¸ºæ•°æ®æ”¶é›†é€†å‘åˆ†æ

## ä¸€ã€è¡Œä¸ºæ•°æ®æ”¶é›†æ¶æ„

TikTok ä½¿ç”¨ä¸¤å¥—ç³»ç»Ÿæ”¶é›†è¡Œä¸ºæ•°æ®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¡Œä¸ºæ•°æ®æ”¶é›†æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ã€webmssdk.jsã€‘                                            â”‚
â”‚    â†’ é¼ æ ‡/é”®ç›˜/è§¦æ‘¸äº‹ä»¶ç›‘å¬                                  â”‚
â”‚    â†’ ubcode (User Behavior Code) ç”Ÿæˆ                       â”‚
â”‚    â†’ ç”¨äº X-Bogus ç­¾åéªŒè¯                                   â”‚
â”‚                                                             â”‚
â”‚  ã€Slardar SDKã€‘                                            â”‚
â”‚    â†’ æ€§èƒ½ç›‘æ§ (TTI, FMP)                                    â”‚
â”‚    â†’ é”™è¯¯ç›‘æ§ (jsError, resourceError)                      â”‚
â”‚    â†’ ç½‘ç»œè¯·æ±‚ç›‘æ§ (ajax, fetch)                             â”‚
â”‚    â†’ é¡µé¢è¡Œä¸º (pageview, breadcrumb)                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€webmssdk.js è¡Œä¸ºæ£€æµ‹

### æºç ä½ç½®

**æ–‡ä»¶**: `webmssdk.js`  
**è¡Œå·**: 2777-2802

### è¡Œä¸ºæ£€æµ‹æ ‡å¿— (ubcode)

```javascript
// è¡Œä¸ºå¼‚å¸¸æ£€æµ‹æ ‡å¿—
i.o[943].v = {
    kNoMove: 2,           // æ— é¼ æ ‡ç§»åŠ¨ (æœºå™¨äººç‰¹å¾)
    kNoClickTouch: 4,     // æ— ç‚¹å‡»/è§¦æ‘¸ (æœºå™¨äººç‰¹å¾)
    kNoKeyboardEvent: 8,  // æ— é”®ç›˜äº‹ä»¶ (æœºå™¨äººç‰¹å¾)
    kMoveFast: 16,        // é¼ æ ‡ç§»åŠ¨è¿‡å¿« (æœºå™¨äººç‰¹å¾)
    kKeyboardFast: 32,    // é”®ç›˜è¾“å…¥è¿‡å¿« (æœºå™¨äººç‰¹å¾)
    kFakeOperations: 64,  // ä¼ªé€ æ“ä½œ (JSæ¨¡æ‹Ÿ)
    kUntrusted: 128       // ä¸å¯ä¿¡äº‹ä»¶ (isTrusted=false)
};

// ubcode å­˜å‚¨
i.o[944].v = { ubcode: 0 };  // åˆå§‹å€¼ä¸º 0
```

### äº‹ä»¶ç›‘å¬å™¨é…ç½®

```javascript
// äº‹ä»¶å¤„ç†å‡½æ•°æ˜ å°„
i.o[945].v = {};
i.o[945].v.keydown = Y;      // é”®ç›˜æŒ‰ä¸‹å¤„ç†å‡½æ•°
i.o[945].v.keypress = Y;     // é”®ç›˜æŒ‰é”®å¤„ç†å‡½æ•°
i.o[945].v.click = X;        // ç‚¹å‡»å¤„ç†å‡½æ•°
i.o[945].v.dblclick = X;     // åŒå‡»å¤„ç†å‡½æ•°
i.o[945].v.touchstart = X;   // è§¦æ‘¸å¼€å§‹å¤„ç†å‡½æ•°
i.o[945].v.touchmove = L;    // è§¦æ‘¸ç§»åŠ¨å¤„ç†å‡½æ•°
i.o[945].v.mousemove = L;    // é¼ æ ‡ç§»åŠ¨å¤„ç†å‡½æ•°
```

### æ•°æ®å­˜å‚¨ä½ç½®

```javascript
i.o[939].v = [];  // é¼ æ ‡ç§»åŠ¨æ•°æ®
i.o[938].v = [];  // é”®ç›˜äº‹ä»¶æ•°æ®
i.o[936].v = [];  // å…¶ä»–è¡Œä¸ºæ•°æ®
i.o[944].v = { ubcode: 0 };  // è¡Œä¸ºå¼‚å¸¸ä»£ç 
```

## ä¸‰ã€è¡Œä¸ºå¼‚å¸¸æ£€æµ‹é€»è¾‘

### ubcode è®¡ç®—

```javascript
/**
 * ubcode (User Behavior Code) è®¡ç®—é€»è¾‘è¿˜åŸ
 * ubcode æ˜¯ä¸€ä¸ªä½å›¾ï¼Œæ¯ä¸€ä½è¡¨ç¤ºä¸€ç§å¼‚å¸¸è¡Œä¸º
 */

let ubcode = 0;

// 1. æ£€æµ‹æ˜¯å¦æœ‰é¼ æ ‡ç§»åŠ¨
if (noMouseMoveDetected) {
    ubcode |= 2;  // kNoMove
}

// 2. æ£€æµ‹æ˜¯å¦æœ‰ç‚¹å‡»/è§¦æ‘¸
if (noClickOrTouchDetected) {
    ubcode |= 4;  // kNoClickTouch
}

// 3. æ£€æµ‹æ˜¯å¦æœ‰é”®ç›˜äº‹ä»¶
if (noKeyboardEventDetected) {
    ubcode |= 8;  // kNoKeyboardEvent
}

// 4. æ£€æµ‹é¼ æ ‡ç§»åŠ¨æ˜¯å¦è¿‡å¿«
if (mouseMoveToFast) {
    ubcode |= 16;  // kMoveFast
}

// 5. æ£€æµ‹é”®ç›˜è¾“å…¥æ˜¯å¦è¿‡å¿«
if (keyboardInputTooFast) {
    ubcode |= 32;  // kKeyboardFast
}

// 6. æ£€æµ‹æ˜¯å¦æœ‰ä¼ªé€ æ“ä½œ (é€šè¿‡ JS è§¦å‘)
if (fakeOperationsDetected) {
    ubcode |= 64;  // kFakeOperations
}

// 7. æ£€æµ‹äº‹ä»¶æ˜¯å¦å¯ä¿¡ (isTrusted)
if (untrustedEventDetected) {
    ubcode |= 128;  // kUntrusted
}
```

### ubcode å€¼è§£æ

| ubcode å€¼ | äºŒè¿›åˆ¶ | å«ä¹‰ |
|----------|--------|------|
| 0 | 00000000 | æ­£å¸¸ç”¨æˆ· |
| 2 | 00000010 | æ— é¼ æ ‡ç§»åŠ¨ |
| 4 | 00000100 | æ— ç‚¹å‡»/è§¦æ‘¸ |
| 6 | 00000110 | æ— é¼ æ ‡ç§»åŠ¨ + æ— ç‚¹å‡» |
| 128 | 10000000 | äº‹ä»¶ä¸å¯ä¿¡ |
| 254 | 11111110 | é«˜åº¦å¯ç–‘æœºå™¨äºº |

## å››ã€äº‹ä»¶çœŸå®æ€§æ£€æµ‹

### isTrusted æ£€æµ‹

```javascript
// TikTok æ£€æµ‹äº‹ä»¶æ˜¯å¦ç”±ç”¨æˆ·è§¦å‘
function handleEvent(event) {
    // æ£€æŸ¥ isTrusted å±æ€§
    // ç”¨æˆ·æ“ä½œ: isTrusted = true
    // JS æ¨¡æ‹Ÿ: isTrusted = false
    if (!event.isTrusted) {
        ubcode |= 128;  // kUntrusted
    }
}
```

### æ—¶é—´é—´éš”æ£€æµ‹

```javascript
// æ£€æµ‹æ“ä½œæ˜¯å¦è¿‡å¿« (æœºå™¨äººç‰¹å¾)
let lastMoveTime = 0;

function onMouseMove(event) {
    const now = Date.now();
    const interval = now - lastMoveTime;
    
    // å¦‚æœç§»åŠ¨é—´éš” < 10msï¼Œå¯èƒ½æ˜¯æœºå™¨äºº
    if (interval < 10) {
        ubcode |= 16;  // kMoveFast
    }
    
    lastMoveTime = now;
}
```

## äº”ã€Slardar SDK è¡Œä¸ºæ”¶é›†

### æ’ä»¶åˆ—è¡¨

| æ’ä»¶å | ç‰ˆæœ¬ | åŠŸèƒ½ |
|--------|------|------|
| pageview | 1.16.5 | é¡µé¢æµè§ˆè¿½è¸ª |
| ajax | 1.16.5 | XHR è¯·æ±‚ç›‘æ§ |
| fetch | 1.16.5 | Fetch è¯·æ±‚ç›‘æ§ |
| breadcrumb | 1.16.5 | ç”¨æˆ·è¡Œä¸ºé¢åŒ…å±‘ |
| jsError | 1.16.5 | JS é”™è¯¯æ•è· |
| performance | 1.16.5 | æ€§èƒ½æŒ‡æ ‡æ”¶é›† |
| resourceError | 1.16.5 | èµ„æºé”™è¯¯ç›‘æ§ |
| resource | 1.16.5 | èµ„æºåŠ è½½ç›‘æ§ |
| tti | 1.12.2 | Time To Interactive |
| fmp | 1.12.2 | First Meaningful Paint |

### è¡Œä¸ºäº‹ä»¶è®¢é˜…

```javascript
// Slardar è®¢é˜…çš„è¡Œä¸ºäº‹ä»¶
subject: {
    click_0:      // ç‚¹å‡»äº‹ä»¶
    keypress_0:   // æŒ‰é”®äº‹ä»¶
    xhr_0:        // XHR è¯·æ±‚
    fetch_0:      // Fetch è¯·æ±‚
    hidden_3:     // é¡µé¢éšè—
    unload_0:     // é¡µé¢å¸è½½
    hash_0:       // URL hash å˜åŒ–
    history_0:    // History API è°ƒç”¨
    longtask_0:   // é•¿ä»»åŠ¡
    load_1:       // é¡µé¢åŠ è½½
    err_0:        // JS é”™è¯¯
    perr_0:       // Promise é”™è¯¯
    resource_0:   // èµ„æºåŠ è½½
    activated_0:  // é¡µé¢æ¿€æ´»
}
```

## å…­ã€è¡Œä¸ºæ•°æ®ç”¨é€”

### 1. X-Bogus ç­¾åéªŒè¯

```javascript
// ubcode å‚ä¸ç­¾åè®¡ç®—
const signData = {
    url: requestUrl,
    timestamp: Date.now(),
    ubcode: ubcode,  // è¡Œä¸ºå¼‚å¸¸ä»£ç 
    // ... å…¶ä»–æŒ‡çº¹æ•°æ®
};

const xBogus = generateXBogus(signData);
```

### 2. é£æ§åˆ¤æ–­

```javascript
// æœåŠ¡ç«¯æ ¹æ® ubcode åˆ¤æ–­é£é™©
if (ubcode & 128) {
    // äº‹ä»¶ä¸å¯ä¿¡ï¼Œå¯èƒ½æ˜¯è‡ªåŠ¨åŒ–å·¥å…·
    riskLevel = 'high';
}

if (ubcode & 2 && ubcode & 4) {
    // æ— é¼ æ ‡ç§»åŠ¨ä¸”æ— ç‚¹å‡»ï¼Œå¯èƒ½æ˜¯æœºå™¨äºº
    riskLevel = 'high';
}
```

### 3. åçˆ¬è™«

- æ£€æµ‹ Selenium/Puppeteer ç­‰è‡ªåŠ¨åŒ–å·¥å…·
- æ£€æµ‹ JS æ¨¡æ‹Ÿçš„ç‚¹å‡»äº‹ä»¶
- æ£€æµ‹å¼‚å¸¸çš„æ“ä½œé€Ÿåº¦

## ä¸ƒã€ç»•è¿‡æ–¹æ¡ˆ

### 1. æ¨¡æ‹ŸçœŸå®é¼ æ ‡ç§»åŠ¨

```javascript
// æ³¨å…¥çœŸå®çš„é¼ æ ‡ç§»åŠ¨äº‹ä»¶
function simulateRealMouseMove() {
    const event = new MouseEvent('mousemove', {
        bubbles: true,
        cancelable: true,
        view: window,
        clientX: Math.random() * window.innerWidth,
        clientY: Math.random() * window.innerHeight
    });
    
    // å…³é”®: æ— æ³•ä¼ªé€  isTrusted
    // éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹å¼
}
```

### 2. Hook isTrusted

```javascript
// å°è¯• Hook isTrusted (å¯èƒ½ä¸ç”Ÿæ•ˆ)
Object.defineProperty(Event.prototype, 'isTrusted', {
    get: function() {
        return true;
    }
});
```

**æ³¨æ„**: ç°ä»£æµè§ˆå™¨ä¸­ `isTrusted` æ˜¯åªè¯»çš„ï¼Œæ— æ³•è¢«ä¿®æ”¹ã€‚

### 3. ä½¿ç”¨çœŸå®çš„ç”¨æˆ·æ“ä½œ

æœ€å¯é çš„æ–¹å¼æ˜¯ä½¿ç”¨:
- Playwright çš„ `page.mouse.move()` 
- Puppeteer çš„ `page.mouse.move()`
- è¿™äº›å·¥å…·ä¼šç”Ÿæˆ `isTrusted=true` çš„äº‹ä»¶

## å…«ã€è¡Œä¸ºç›‘æ§è„šæœ¬

### ä½¿ç”¨æ–¹æ³•

åœ¨ TikTok é¡µé¢æ§åˆ¶å°ä¸­æ‰§è¡Œ `behavior_monitor.js` è„šæœ¬ã€‚

### åŠŸèƒ½ç‰¹æ€§

1. **å®æ—¶ç›‘æ§é¢æ¿** - å³ä¸Šè§’æ˜¾ç¤ºè¡Œä¸ºæ•°æ®
2. **äº‹ä»¶ç»Ÿè®¡** - é¼ æ ‡ç§»åŠ¨ã€ç‚¹å‡»ã€é”®ç›˜ã€è§¦æ‘¸
3. **é€Ÿåº¦åˆ†æ** - æ£€æµ‹æ“ä½œæ˜¯å¦è¿‡å¿«
4. **é£é™©è¯„ä¼°** - å®æ—¶è®¡ç®— ubcode å’Œé£é™©ç­‰çº§
5. **æ ‡å¿—å¯è§†åŒ–** - æ˜¾ç¤ºå„æ£€æµ‹æ ‡å¿—çŠ¶æ€

### API æ¥å£

```javascript
// è·å–å½“å‰çŠ¶æ€
TikTokMonitor.getStatus()
// è¿”å›: { mouseMoves, clicks, ubcode, flags, risk, ... }

// æ‰“å°è¯¦ç»†æŠ¥å‘Š
TikTokMonitor.printReport()

// æ¨¡æ‹Ÿä¼ªé€ ç‚¹å‡» (æµ‹è¯•æ£€æµ‹)
TikTokMonitor.simulateFakeClick()

// æ¨¡æ‹Ÿå¿«é€Ÿç§»åŠ¨ (æµ‹è¯•æ£€æµ‹)
TikTokMonitor.simulateFastMove(100)

// é‡ç½®æ‰€æœ‰çŠ¶æ€
TikTokMonitor.reset()

// æ˜¾ç¤º/éšè—é¢æ¿
TikTokMonitor.togglePanel()
```

### ç›‘æ§é¢æ¿æˆªå›¾ç¤ºæ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” TikTok è¡Œä¸ºç›‘æ§         Ã— â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¿è¡Œæ—¶é—´:              45s   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é¼ æ ‡ç§»åŠ¨:             128    â”‚
â”‚ ç‚¹å‡»æ¬¡æ•°:               5    â”‚
â”‚ é”®ç›˜æŒ‰é”®:              23    â”‚
â”‚ è§¦æ‘¸äº‹ä»¶:               0    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¹³å‡ç§»åŠ¨é—´éš”:         45ms   â”‚
â”‚ å¹³å‡æŒ‰é”®é—´éš”:        120ms   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸å¯ä¿¡äº‹ä»¶:             0    â”‚
â”‚ ä¼ªé€ äº‹ä»¶:               0    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é£é™©ç­‰çº§:              ä½    â”‚
â”‚ ubcode:         0 (0x0)      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ— ç§»åŠ¨ æ— ç‚¹å‡» æ— æŒ‰é”®   â”‚   â”‚
â”‚ â”‚ ç§»åŠ¨å¿« æŒ‰é”®å¿« ä¼ªé€      â”‚   â”‚
â”‚ â”‚        ä¸å¯ä¿¡          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é£é™©ç­‰çº§åˆ¤æ–­

| ubcode ä½æ•° | é£é™©ç­‰çº§ | è¯´æ˜ |
|------------|---------|------|
| 0 ä½ | ä½ âœ… | æ­£å¸¸ç”¨æˆ·è¡Œä¸º |
| 1-2 ä½ | ä¸­ âš ï¸ | å¯èƒ½è§¦å‘éªŒè¯ |
| 3+ ä½ | é«˜ âŒ | é«˜æ¦‚ç‡è¢«å°ç¦ |

### ç®€åŒ–ç‰ˆæ£€æµ‹ä»£ç 

```javascript
// å¿«é€Ÿæ£€æµ‹å½“å‰ ubcode
(function() {
    const flags = {
        kNoMove: 2, kNoClickTouch: 4, kNoKeyboardEvent: 8,
        kMoveFast: 16, kKeyboardFast: 32, kFakeOperations: 64, kUntrusted: 128
    };
    
    let ubcode = 0;
    let hasMove = false, hasClick = false, hasKey = false;
    
    document.addEventListener('mousemove', () => hasMove = true, { once: true });
    document.addEventListener('click', () => hasClick = true, { once: true });
    document.addEventListener('keydown', () => hasKey = true, { once: true });
    
    setTimeout(() => {
        if (!hasMove) ubcode |= flags.kNoMove;
        if (!hasClick) ubcode |= flags.kNoClickTouch;
        if (!hasKey) ubcode |= flags.kNoKeyboardEvent;
        
        console.log('ubcode:', ubcode, '(0x' + ubcode.toString(16) + ')');
        console.log('é£é™©:', ubcode === 0 ? 'ä½' : ubcode <= 14 ? 'ä¸­' : 'é«˜');
    }, 5000);
})();
```

## ä¹ã€æ€»ç»“

### æ”¶é›†çš„æ•°æ®

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | ç”¨é€” |
|---------|---------|------|
| é¼ æ ‡ç§»åŠ¨ | o[939].v | æ£€æµ‹æ˜¯å¦æœ‰ç§»åŠ¨ |
| é”®ç›˜äº‹ä»¶ | o[938].v | æ£€æµ‹æ˜¯å¦æœ‰è¾“å…¥ |
| è¡Œä¸ºä»£ç  | o[944].v.ubcode | å‚ä¸ç­¾å |
| æ—¶é—´æˆ³ | event.timeStamp | æ£€æµ‹æ“ä½œé€Ÿåº¦ |
| isTrusted | event.isTrusted | æ£€æµ‹æ˜¯å¦å¯ä¿¡ |

### æ£€æµ‹ç›®æ ‡

1. **æ— è¡Œä¸º** - æœºå™¨äººé€šå¸¸ä¸ä¼šç§»åŠ¨é¼ æ ‡
2. **è¡Œä¸ºè¿‡å¿«** - æœºå™¨äººæ“ä½œé€Ÿåº¦å¼‚å¸¸
3. **äº‹ä»¶ä¼ªé€ ** - JS è§¦å‘çš„äº‹ä»¶ isTrusted=false
4. **æ¨¡å¼å¼‚å¸¸** - ç§»åŠ¨è½¨è¿¹ä¸ç¬¦åˆäººç±»ä¹ æƒ¯
